# D-Eskimo 自动泊车系统架构图

## 系统整体架构

```mermaid
graph TB
    subgraph Layer1["应用层 - VDC_APA_APP_Framework"]
        direction TB
        AppM[应用管理<br/>Sf_VCt_L2_ParkingAppM]
        
        subgraph Apps["应用模块"]
            ParkingFus[泊车融合应用<br/>Sf_VCo_L2_ParkingFus]
            UIUE[UI/UE应用<br/>Sf_VM_L2_UIUE]
            ParkingPlan[泊车规划应用<br/>Sf_VM_L2_ParkingPlan]
            USSPerc[超声波感知应用<br/>Sf_VCt_L2_USSPerc]
            SenCalib[传感器标定应用<br/>Sf_VCt_L2_ParkingSenCalib]
            ServiceCalib[服务标定应用<br/>Sf_VCt_L2_ServiceParkingSenCalib]
        end
        
        Middleware[中间件层<br/>Middleware]
        CameraInterface[摄像头接口<br/>Camera Interface]
    end
    
    subgraph Layer2["核心层 - Core/SERVER"]
        direction TB
        
        subgraph Business["业务逻辑层 - BUSINESSLOGIC"]
            BusinessLogic[业务逻辑核心<br/>BusinessLogic]
            HMI[HMI模块]
            Controller[控制器模块]
            DataManager[数据管理模块]
        end
        
        subgraph Perception["感知层 - PERCEPTION"]
            ParkingSpaceUSR[停车位超声波雷达<br/>ParkingSpaceUSR]
            ObstacleSpaceUSR[障碍物超声波雷达<br/>ObstacleSpaceUSR]
            ParkingSpaceCamera[停车位摄像头<br/>ParkingSpaceCamera]
        end
        
        subgraph Fusion["融合层"]
            PerceptionFusion[感知融合<br/>PerceptionFusion]
            FusionDecision[融合决策<br/>FusionDecision]
            ObjectFusion[目标融合<br/>ObjectFusion]
            ParkingSpaceFusion[停车位融合<br/>ParkingSpaceFusion]
        end
        
        subgraph Position["定位层 - FusionPosition"]
            FusionPosition[融合定位<br/>FusionPosition]
            VehiclePosition[车辆定位<br/>VehiclePosition]
            LocationAPA[APA定位<br/>Location_APA]
        end
        
        subgraph Visual["视觉感知层 - VISUALPERCEPTION"]
            VisualObject[视觉目标检测<br/>VisualObject]
            FreeSpaceSS[自由空间检测<br/>FreeSpaceSS]
            ParkingSpaceSemantics[停车位语义<br/>ParkingSpaceSemantics]
            CameraDirtyCheck[摄像头脏污检测<br/>CameraDirtyCheck]
        end
        
        subgraph Data["数据接口层 - DATA"]
            VehicleData[车辆数据<br/>VehicleData]
            CameraData[摄像头数据<br/>CameraData]
            USRData[超声波雷达数据<br/>USRData]
            FrontRadarData[前雷达数据<br/>FrontRadarData]
            FrontCameraData[前摄像头数据<br/>FrontCameraData]
        end
        
        subgraph Service["服务层 - SERVICE"]
            Logger[日志服务<br/>DoggyLogger]
            MemManager[内存管理<br/>MemManager]
            CommAdaptor[通信适配器<br/>CommunicationAdaptor]
            ConfigCache[配置缓存<br/>ConfigureCache]
            HealthManagement[健康管理<br/>HealthManagement]
            OSAdaptor[操作系统适配器<br/>OSAdaptor]
        end
        
        subgraph Main["主程序层 - MAIN"]
            Main[主程序入口<br/>Main]
            LogicProxy[逻辑代理<br/>LogicProxy]
        end
        
        Display[显示模块<br/>DISPLAY]
        USRWarning[预警模块<br/>WARNING/USRWarning]
        CameraCalib[标定模块<br/>CALIB/CameraCALIB]
        
        ThirdPart[第三方库<br/>OpenCV/Eigen3]
    end
    
    subgraph Layer3["基础层 - AppBase"]
        APAService[APA服务<br/>apa_service]
        HeartBeat[心跳检测<br/>HeartBeat]
        FusMain[融合主程序<br/>FusMain]
        UIMain[UI主程序<br/>UIMain]
        BusinessLogicMain[业务逻辑主程序<br/>BusinessLogicMain]
    end
    
    subgraph Comm["通信协议层"]
        DDS[DDS<br/>数据分发服务]
        SOMEIP[SOME/IP<br/>服务通信]
        IPC[IPC<br/>进程间通信]
    end
    
    subgraph External["外部接口"]
        VehicleECU[车辆ECU<br/>EPS/ABS/IBC/DMS]
        Sensors[传感器<br/>摄像头/雷达/USR]
    end
    
    %% 应用层内部连接
    AppM --> Apps
    Apps --> Middleware
    
    %% 应用层到核心层
    ParkingFus --> PerceptionFusion
    ParkingFus --> FusionDecision
    USSPerc --> ParkingSpaceUSR
    ParkingPlan --> BusinessLogic
    UIUE --> Display
    UIUE --> HMI
    SenCalib --> CameraCalib
    ServiceCalib --> CameraCalib
    
    %% 核心层内部连接
    BusinessLogic --> Controller
    BusinessLogic --> DataManager
    BusinessLogic --> HMI
    BusinessLogic --> FusionDecision
    BusinessLogic --> FusionPosition
    
    PerceptionFusion --> ParkingSpaceUSR
    PerceptionFusion --> ObstacleSpaceUSR
    PerceptionFusion --> ParkingSpaceCamera
    PerceptionFusion --> VisualObject
    
    FusionDecision --> ObjectFusion
    FusionDecision --> ParkingSpaceFusion
    FusionDecision --> PerceptionFusion
    
    %% 数据流
    VehicleData --> BusinessLogic
    CameraData --> PerceptionFusion
    USRData --> ParkingSpaceUSR
    USRData --> ObstacleSpaceUSR
    FrontRadarData --> FusionDecision
    FrontCameraData --> VisualObject
    
    %% 服务层连接
    Main --> Service
    LogicProxy --> CommAdaptor
    BusinessLogic --> LogicProxy
    
    %% 基础层连接
    APAService --> BusinessLogicMain
    APAService --> FusMain
    APAService --> UIMain
    APAService --> HeartBeat
    BusinessLogicMain --> BusinessLogic
    FusMain --> PerceptionFusion
    UIMain --> Display
    
    %% 通信协议连接
    Middleware --> Comm
    CommAdaptor --> Comm
    
    %% 外部接口连接
    VehicleECU --> VehicleData
    Sensors --> Data
    CameraInterface --> CameraData
    CameraInterface --> VisualObject
    
    %% 第三方库
    VisualObject --> ThirdPart
    PerceptionFusion --> ThirdPart
    FusionPosition --> ThirdPart
    
    %% 样式
    classDef appLayer fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef coreLayer fill:#fff4e1,stroke:#e65100,stroke-width:2px
    classDef baseLayer fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef commLayer fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef dataLayer fill:#f3e5f5,stroke:#6a1b9a,stroke-width:2px
    
    class AppM,ParkingFus,UIUE,ParkingPlan,USSPerc,SenCalib,ServiceCalib appLayer
    class BusinessLogic,PerceptionFusion,FusionDecision,FusionPosition,VisualObject coreLayer
    class APAService,HeartBeat,FusMain,UIMain,BusinessLogicMain baseLayer
    class DDS,SOMEIP,IPC commLayer
    class VehicleData,CameraData,USRData,FrontRadarData,FrontCameraData dataLayer
```

## 分层架构图

```mermaid
graph LR
    subgraph L1["第一层：应用层"]
        A1[泊车融合应用]
        A2[UI/UE应用]
        A3[泊车规划应用]
        A4[超声波感知应用]
    end
    
    subgraph L2["第二层：业务逻辑层"]
        B1[业务逻辑核心]
        B2[融合决策]
        B3[轨迹规划]
        B4[轨迹跟踪]
    end
    
    subgraph L3["第三层：感知融合层"]
        C1[感知融合]
        C2[目标融合]
        C3[停车位融合]
    end
    
    subgraph L4["第四层：感知层"]
        D1[超声波感知]
        D2[视觉感知]
        D3[雷达感知]
    end
    
    subgraph L5["第五层：数据接口层"]
        E1[车辆数据]
        E2[传感器数据]
    end
    
    subgraph L6["第六层：服务层"]
        F1[日志服务]
        F2[内存管理]
        F3[通信适配]
    end
    
    L1 --> L2
    L2 --> L3
    L3 --> L4
    L4 --> L5
    L5 --> L6
    
    style L1 fill:#e1f5ff
    style L2 fill:#fff4e1
    style L3 fill:#f3e5f5
    style L4 fill:#e8f5e9
    style L5 fill:#ffebee
    style L6 fill:#fce4ec
```

## 数据流架构图

```mermaid
flowchart LR
    subgraph Input["输入数据源"]
        S1[摄像头]
        S2[超声波雷达]
        S3[前雷达]
        S4[车辆ECU]
    end
    
    subgraph DataLayer["数据接口层"]
        D1[CameraData]
        D2[USRData]
        D3[FrontRadarData]
        D4[VehicleData]
    end
    
    subgraph PerceptionLayer["感知处理层"]
        P1[视觉感知<br/>VisualObject]
        P2[超声波感知<br/>ParkingSpaceUSR]
        P3[雷达感知]
    end
    
    subgraph FusionLayer["融合层"]
        F1[感知融合<br/>PerceptionFusion]
        F2[目标融合<br/>ObjectFusion]
        F3[停车位融合<br/>ParkingSpaceFusion]
    end
    
    subgraph DecisionLayer["决策层"]
        DE1[融合决策<br/>FusionDecision]
        DE2[路径规划<br/>ParkingPlan]
    end
    
    subgraph ControlLayer["控制层"]
        C1[轨迹跟踪]
        C2[车辆控制]
    end
    
    subgraph Output["输出"]
        O1[控制指令]
        O2[UI显示]
        O3[预警信息]
    end
    
    S1 --> D1
    S2 --> D2
    S3 --> D3
    S4 --> D4
    
    D1 --> P1
    D2 --> P2
    D3 --> P3
    D4 --> DE1
    
    P1 --> F1
    P2 --> F1
    P3 --> F1
    
    F1 --> F2
    F1 --> F3
    
    F2 --> DE1
    F3 --> DE1
    
    DE1 --> DE2
    DE2 --> C1
    C1 --> C2
    
    C2 --> O1
    DE1 --> O2
    P2 --> O3
    
    style Input fill:#e8f5e9
    style DataLayer fill:#fff4e1
    style PerceptionLayer fill:#e1f5ff
    style FusionLayer fill:#f3e5f5
    style DecisionLayer fill:#ffebee
    style ControlLayer fill:#fce4ec
    style Output fill:#e0f2f1
```

## 模块通信架构图

```mermaid
graph TB
    subgraph Apps["应用模块"]
        App1[ParkingFus]
        App2[UIUE]
        App3[ParkingPlan]
        App4[USSPerc]
    end
    
    subgraph Middleware["中间件层"]
        MW1[DDS通信]
        MW2[SOME/IP通信]
        MW3[IPC通信]
    end
    
    subgraph Core["核心模块"]
        C1[BusinessLogic]
        C2[PerceptionFusion]
        C3[FusionDecision]
    end
    
    subgraph Service["服务模块"]
        S1[Logger]
        S2[MemManager]
        S3[CommAdaptor]
    end
    
    App1 <--> MW1
    App2 <--> MW2
    App3 <--> MW1
    App4 <--> MW3
    
    MW1 <--> C1
    MW2 <--> C2
    MW3 <--> C3
    
    C1 <--> S1
    C2 <--> S2
    C3 <--> S3
    
    style Apps fill:#e1f5ff
    style Middleware fill:#fff4e1
    style Core fill:#f3e5f5
    style Service fill:#e8f5e9
```

## 方法调用关系详细架构图

### 1. 感知融合模块方法调用关系

```mermaid
classDiagram
    class ParkingFusDataDispatch {
        +Send_APP_SF_APA_Slot()
        +Send_APP_SF_APA_Replan_Slot()
        +Send_APP_SF_APA_FSP_Distance()
        +Send_APP_Sf_APA_ObjInfo()
        +Set_SF_APA_USS_Slot_Info_CallFunc()
        +Set_SF_APA_USS_Object_Info_CallFunc()
    }
    
    class IPerceptionFusion {
        +PerceptionFusionStart()
        +PerceptionFusionStop()
        +PerceptionSearchingSlot()
        +PerceptionObstcleDetect()
        +PerceptionParkingReplan()
        +PerceptionFreeSpace()
        +PerceptionFawObj()
        +PerceptionFawDD()
        +PerceptionSendVeh()
        +PerceptionSendUslot()
        +PerceptionSendVpf()
        +PerceptionSendUSSSlot()
        +PerceptionSendUSSCurb()
        +PerceptionSendUSSObjInfo()
        +PerceptionSendReplan()
    }
    
    class PerceptionFusion {
        -ThreadProc()
        -logCallBack()
        +PerceptionFusionStart()
        +PerceptionFusionStop()
        +PerceptionSendVeh()
        +PerceptionSendUslot()
        +PerceptionSendVpf()
    }
    
    class np_api {
        +np_init()
        +np_exit()
        +np_send_veh()
        +np_send_uslot()
        +np_send_vpf()
        +np_set_log()
        +np_run()
    }
    
    class VisualObject {
        +PerceptionPostprocess()
        +SelectFrameResult()
        +ConvertVpfData()
        +update_cameras_status()
    }
    
    ParkingFusDataDispatch --> IPerceptionFusion : 调用接口方法
    IPerceptionFusion <|.. PerceptionFusion : 实现接口
    PerceptionFusion --> np_api : 调用算法接口
    np_api --> VisualObject : 调用视觉处理
```

### 2. 业务逻辑模块方法调用关系

```mermaid
classDiagram
    class BusinessLogic_IF {
        +BusinessLogicStart()
        +BusinessLogicStop()
    }
    
    class CBusinessLogic {
        -m_avm_controller
        -m_gl_controller
        -m_user_config
        +GetInstance()
        +Init()
        +Start()
        +Stop()
        +DeInit()
        +OnEventNotifyCB()
        +UpdateVehicleData()
        +UpdateRadarData()
        -checkVehicleDataValid()
        -convertVehicleData()
        -convertRadarData()
    }
    
    class CommunicationNode_APA {
        +APA_StartSearchParking()
        +APA_StopSearchParking()
        +APA_SetParkInTargetParkingSpace()
        +APA_StartParkIn()
        +APA_StartParkOut()
        +APA_SuspendPark()
        +APA_ResumePark()
        +APA_StopPark()
        +APA_GetParkPlotMult()
        +SetAPACallBack()
        +SetVehicleControllerCallBack()
        +APA_OnSearchParking()
        +APA_OnParkPlanPoint()
        +APA_OnParkStatus()
        +APA_OnTrackingInfo()
        +APA_OnTrackingState()
    }
    
    class LogicProxy {
        +APACommunicatorStart()
        +APACommunicatorStop()
        +NRecvMsg_APACommunicator_OnSearchParking()
        +NRecvMsg_APACommunicator_OnParkPlanPoint()
        +NRecvMsg_APACommunicator_OnParkStatus()
        +NRecvMsg_APACommunicator_OnTrackingInfo()
        +NRecvMsg_APACommunicator_OnTrackingState()
        +comm_proxy_push_message()
        +comm_proxy_consume_message()
    }
    
    class DataManager {
        +GetVehicleData()
        +UpdateVehicleData()
    }
    
    BusinessLogic_IF --> CBusinessLogic : 调用实例方法
    CBusinessLogic --> CommunicationNode_APA : 使用通信节点
    CBusinessLogic --> DataManager : 管理数据
    CommunicationNode_APA --> LogicProxy : 回调通知
    LogicProxy --> CBusinessLogic : 消息通知
```

### 3. 融合决策模块方法调用关系

```mermaid
classDiagram
    class IFusionDecision {
        +IFuisonDecisionInit()
        +IFuisonDecisionStart()
        +IFuisonDecisionStop()
        +IFuisonDecisionUninit()
    }
    
    class FusionDecision {
        +Init()
        +Start()
        +Stop()
        +ProcessFusionData()
        +MakeDecision()
    }
    
    class ObjectFusion {
        +FuseObjects()
        +UpdateObjectList()
    }
    
    class ParkingSpaceFusion {
        +FuseParkingSpaces()
        +UpdateParkingSpaceList()
    }
    
    IFusionDecision <|.. FusionDecision : 实现接口
    FusionDecision --> ObjectFusion : 调用目标融合
    FusionDecision --> ParkingSpaceFusion : 调用停车位融合
```

### 4. 完整的数据流和调用序列图

#### 4.1 车位搜索流程

```mermaid
sequenceDiagram
    participant UI as UI应用
    participant App as ParkingFus应用
    participant Dispatch as DataDispatch
    participant PF as PerceptionFusion
    participant NP as np_api
    participant VO as VisualObject
    participant FD as FusionDecision
    participant BL as BusinessLogic
    participant Comm as CommunicationNode
    
    UI->>App: 用户触发搜索车位
    App->>Dispatch: Send_APP_SF_APA_Slot(超声波车位)
    Dispatch->>PF: PerceptionSendUslot(msg)
    PF->>NP: np_send_uslot(msg)
    
    App->>Dispatch: Send_APP_Sf_APA_ObjInfo(视觉信息)
    Dispatch->>PF: PerceptionSendVpf(msg)
    PF->>NP: np_send_vpf(msg)
    
    App->>Dispatch: 发送车辆数据
    Dispatch->>PF: PerceptionSendVeh(msg)
    PF->>NP: np_send_veh(msg)
    
    App->>PF: PerceptionSearchingSlot(enable=true, callback)
    PF->>NP: 启动车位搜索算法
    NP->>NP: np_run()循环处理
    
    loop 算法处理循环
        NP->>VO: PerceptionPostprocess()
        VO->>VO: SelectFrameResult()
        VO->>VO: ConvertVpfData()
        VO-->>NP: 返回视觉处理结果
        NP->>NP: 融合超声波和视觉数据
        NP-->>PF: 触发ON_FUS_SLT回调
    end
    
    PF-->>Dispatch: ON_FUS_SLT(融合车位信息)
    Dispatch-->>App: 车位信息回调
    
    App->>FD: 发送融合数据
    FD->>FD: ProcessFusionData()
    FD->>FD: MakeDecision()
    FD-->>BL: 决策结果
    
    BL->>BL: OnEventNotifyCB(EVENT_SEARCH_PARKING)
    BL->>Comm: APA_OnSearchParking(num, parkList)
    Comm->>UI: 通知UI显示车位
```

#### 4.2 泊车执行流程

```mermaid
sequenceDiagram
    participant UI as UI应用
    participant Plan as ParkingPlan应用
    participant BL as BusinessLogic
    participant Comm as CommunicationNode
    participant VC as VehicleController
    participant Track as TrajectoryTracking
    
    UI->>Plan: 用户选择车位并确认
    Plan->>BL: APA_SetParkInTargetParkingSpace(parkingId)
    BL->>BL: 验证车位有效性
    BL->>Plan: 返回设置结果
    
    Plan->>BL: APA_StartParkIn(controlCar=true)
    BL->>BL: 生成泊车路径
    BL->>Track: 开始轨迹跟踪
    Track->>VC: 发送控制指令
    
    loop 泊车执行
        VC->>VC: 执行车辆控制
        VC-->>Track: OnTrackingInfo(跟踪信息)
        Track->>Track: 更新跟踪状态
        Track-->>BL: OnTrackingState(跟踪状态)
        BL->>BL: 判断是否需要调整
        BL->>VC: 发送新的控制指令
    end
    
    VC-->>BL: OnVehicleControlCommand(控制命令)
    BL->>BL: 更新泊车状态
    BL->>Comm: APA_OnParkStatus(status)
    Comm->>UI: 通知UI更新状态
```

#### 4.3 障碍物检测流程

```mermaid
sequenceDiagram
    participant USS as 超声波雷达
    participant App as ParkingFus应用
    participant Dispatch as DataDispatch
    participant PF as PerceptionFusion
    participant NP as np_api
    participant FD as FusionDecision
    participant BL as BusinessLogic
    participant Warning as Warning模块
    
    USS->>App: 发送超声波障碍物数据
    App->>Dispatch: Send_APP_SF_APA_USS_Object_Info()
    Dispatch->>PF: PerceptionSendUSSObjInfo(msg)
    PF->>NP: np_send_ussobjinfo(msg)
    
    App->>PF: PerceptionObstcleDetect(enable=true, callback)
    PF->>NP: 启动障碍物检测
    
    loop 障碍物检测循环
        NP->>NP: np_run()处理障碍物数据
        NP->>NP: 融合多传感器障碍物信息
        NP-->>PF: 触发ON_FUS_OBJ_DETECT回调
    end
    
    PF-->>Dispatch: ON_FUS_OBJ_DETECT(障碍物信息)
    Dispatch-->>App: 障碍物检测回调
    
    App->>FD: 发送障碍物数据
    FD->>FD: ProcessFusionData()
    FD->>FD: MakeDecision()
    FD-->>BL: 障碍物决策结果
    
    BL->>Warning: 发送预警信息
    Warning->>Warning: 生成预警
    Warning-->>UI: 显示预警信息
```

```mermaid
sequenceDiagram
    participant App as ParkingFus应用
    participant Dispatch as ParkingFusDataDispatch
    participant PF as PerceptionFusion
    participant NP as np_api算法
    participant VO as VisualObject
    participant FD as FusionDecision
    participant BL as BusinessLogic
    
    App->>Dispatch: Send_APP_SF_APA_Slot()
    Dispatch->>PF: PerceptionSendUslot()
    PF->>NP: np_send_uslot()
    
    App->>Dispatch: Send_APP_Sf_APA_ObjInfo()
    Dispatch->>PF: PerceptionSendVpf()
    PF->>NP: np_send_vpf()
    NP->>VO: PerceptionPostprocess()
    VO-->>NP: 返回视觉处理结果
    NP-->>PF: 回调融合结果
    PF-->>Dispatch: ON_FUS_SLT回调
    Dispatch-->>App: 车位信息回调
    
    App->>PF: PerceptionSearchingSlot(enable=true)
    PF->>NP: 启动车位搜索
    NP->>NP: np_run()循环处理
    NP-->>PF: 车位融合结果
    PF-->>Dispatch: ON_FUS_SLT回调
    
    Dispatch->>FD: 发送融合数据
    FD->>FD: MakeDecision()
    FD-->>BL: 决策结果
    BL->>BL: OnEventNotifyCB()
```

### 5. 回调函数调用关系图

```mermaid
graph LR
    subgraph Callbacks["回调函数体系"]
        C1[ON_FUS_SLT<br/>融合车位回调]
        C2[ON_FUS_OBJ_DETECT<br/>障碍物检测回调]
        C3[ON_FUS_FREESPACE<br/>自由空间回调]
        C4[ON_FUS_REPLAN<br/>重定位回调]
        C5[ON_FUS_FAWOBJ<br/>语义目标回调]
        C6[ON_FUS_FAWDD<br/>脏污检测回调]
    end
    
    subgraph PF["PerceptionFusion"]
        PF1[PerceptionSearchingSlot]
        PF2[PerceptionObstcleDetect]
        PF3[PerceptionFreeSpace]
        PF4[PerceptionParkingReplan]
        PF5[PerceptionFawObj]
        PF6[PerceptionFawDD]
    end
    
    subgraph Dispatch["ParkingFusDataDispatch"]
        D1[OnFusionSlotCallback]
        D2[OnFusionObjCallback]
        D3[OnFusionFreespaceCallback]
    end
    
    PF1 -->|注册回调| C1
    PF2 -->|注册回调| C2
    PF3 -->|注册回调| C3
    PF4 -->|注册回调| C4
    PF5 -->|注册回调| C5
    PF6 -->|注册回调| C6
    
    C1 -->|触发| D1
    C2 -->|触发| D2
    C3 -->|触发| D3
    
    style Callbacks fill:#fff4e1
    style PF fill:#e1f5ff
    style Dispatch fill:#e8f5e9
```

### 6. 完整的方法调用流程图

```mermaid
flowchart TD
    Start([系统启动]) --> BLStart[BusinessLogicStart]
    BLStart --> BLInit[CBusinessLogic::Init]
    BLInit --> BLStart2[CBusinessLogic::Start]
    
    BLStart2 --> PFStart[PerceptionFusionStart]
    PFStart --> NPInit[np_init]
    NPInit --> ThreadStart[启动处理线程]
    
    ThreadStart --> LoopStart{循环处理}
    LoopStart -->|接收数据| RecvData[接收传感器数据]
    RecvData --> SendVeh[PerceptionSendVeh]
    RecvData --> SendUslot[PerceptionSendUslot]
    RecvData --> SendVpf[PerceptionSendVpf]
    
    SendVeh --> NPSend[np_send_veh]
    SendUslot --> NPSend2[np_send_uslot]
    SendVpf --> NPSend3[np_send_vpf]
    
    NPSend --> NPRun[np_run算法处理]
    NPSend2 --> NPRun
    NPSend3 --> NPRun
    
    NPRun --> VOProcess[VisualObject::PerceptionPostprocess]
    VOProcess --> FuseResult[融合结果]
    FuseResult --> Callback[回调ON_FUS_SLT]
    
    Callback --> FDProcess[FusionDecision::ProcessFusionData]
    FDProcess --> MakeDecision[MakeDecision决策]
    MakeDecision --> BLNotify[CBusinessLogic::OnEventNotifyCB]
    
    BLNotify --> CommNode[CommunicationNode_APA::APA_OnSearchParking]
    CommNode --> LogicProxy[LogicProxy::NRecvMsg_APACommunicator_OnSearchParking]
    LogicProxy --> LoopStart
    
    LoopStart -->|停止| Stop([系统停止])
    Stop --> PFStop[PerceptionFusionStop]
    PFStop --> NPExit[np_exit]
    NPExit --> BLStop[BusinessLogicStop]
    BLStop --> BLDeInit[CBusinessLogic::DeInit]
```

### 7. 模块间方法调用详细关系

```mermaid
graph TB
    subgraph AppLayer["应用层方法调用"]
        A1[ParkingFusDataDispatch::Send_APP_SF_APA_Slot]
        A2[ParkingFusDataDispatch::Send_APP_Sf_APA_ObjInfo]
        A3[ParkingFusDataDispatch::Send_APP_SF_APA_Replan_Slot]
        A4[ParkingFusDataDispatch::Set_SF_APA_USS_Slot_Info_CallFunc]
    end
    
    subgraph PerceptionLayer["感知融合层方法调用"]
        P1[PerceptionFusion::PerceptionFusionStart]
        P2[PerceptionFusion::PerceptionSearchingSlot]
        P3[PerceptionFusion::PerceptionSendVeh]
        P4[PerceptionFusion::PerceptionSendUslot]
        P5[PerceptionFusion::PerceptionSendVpf]
        P6[PerceptionFusion::PerceptionSendUSSSlot]
        P7[PerceptionFusion::PerceptionObstcleDetect]
        P8[PerceptionFusion::PerceptionParkingReplan]
    end
    
    subgraph AlgorithmLayer["算法层方法调用"]
        AL1[np_api::np_init]
        AL2[np_api::np_send_veh]
        AL3[np_api::np_send_uslot]
        AL4[np_api::np_send_vpf]
        AL5[np_api::np_run]
        AL6[np_api::np_exit]
    end
    
    subgraph VisualLayer["视觉处理层方法调用"]
        V1[VisualObject::PerceptionPostprocess]
        V2[VisualObject::SelectFrameResult]
        V3[VisualObject::ConvertVpfData]
        V4[VisualObject::update_cameras_status]
    end
    
    subgraph DecisionLayer["决策层方法调用"]
        D1[FusionDecision::IFuisonDecisionInit]
        D2[FusionDecision::IFuisonDecisionStart]
        D3[FusionDecision::ProcessFusionData]
        D4[FusionDecision::MakeDecision]
    end
    
    subgraph BusinessLayer["业务逻辑层方法调用"]
        B1[CBusinessLogic::Init]
        B2[CBusinessLogic::Start]
        B3[CBusinessLogic::OnEventNotifyCB]
        B4[CBusinessLogic::UpdateVehicleData]
        B5[CBusinessLogic::UpdateRadarData]
    end
    
    subgraph CommLayer["通信层方法调用"]
        C1[CommunicationNode_APA::APA_StartSearchParking]
        C2[CommunicationNode_APA::APA_OnSearchParking]
        C3[LogicProxy::NRecvMsg_APACommunicator_OnSearchParking]
        C4[LogicProxy::comm_proxy_push_message]
        C5[LogicProxy::comm_proxy_consume_message]
    end
    
    A1 --> P4
    A2 --> P5
    A3 --> P8
    A4 --> P6
    
    P1 --> AL1
    P2 --> AL5
    P3 --> AL2
    P4 --> AL3
    P5 --> AL4
    P6 --> AL3
    
    AL5 --> V1
    V1 --> V2
    V1 --> V3
    V1 --> V4
    
    P7 --> D3
    P8 --> D3
    D3 --> D4
    
    D4 --> B3
    B3 --> C1
    C1 --> C2
    C2 --> C3
    C3 --> C4
    C4 --> C5
    
    style AppLayer fill:#e1f5ff
    style PerceptionLayer fill:#fff4e1
    style AlgorithmLayer fill:#f3e5f5
    style VisualLayer fill:#e8f5e9
    style DecisionLayer fill:#ffebee
    style BusinessLayer fill:#fce4ec
    style CommLayer fill:#e0f2f1
```

### 8. 关键接口方法列表

#### PerceptionFusion接口方法
- `PerceptionFusionStart()` - 启动感知融合
- `PerceptionFusionStop()` - 停止感知融合
- `PerceptionSearchingSlot()` - 搜索车位控制
- `PerceptionObstcleDetect()` - 障碍物检测
- `PerceptionParkingReplan()` - 泊车重定位
- `PerceptionFreeSpace()` - 自由空间检测
- `PerceptionFawObj()` - 语义目标信息
- `PerceptionFawDD()` - 脏污检测
- `PerceptionSendVeh()` - 发送车辆信息
- `PerceptionSendUslot()` - 发送超声波车位信息
- `PerceptionSendVpf()` - 发送视觉信息
- `PerceptionSendUSSSlot()` - 发送超声波车位信息
- `PerceptionSendUSSCurb()` - 发送路沿信息
- `PerceptionSendUSSObjInfo()` - 发送障碍物信息
- `PerceptionSendReplan()` - 发送重定位信息

#### BusinessLogic接口方法
- `BusinessLogicStart()` - 启动业务逻辑
- `BusinessLogicStop()` - 停止业务逻辑
- `CBusinessLogic::Init()` - 初始化
- `CBusinessLogic::Start()` - 启动
- `CBusinessLogic::Stop()` - 停止
- `CBusinessLogic::OnEventNotifyCB()` - 事件通知回调
- `CBusinessLogic::UpdateVehicleData()` - 更新车辆数据
- `CBusinessLogic::UpdateRadarData()` - 更新雷达数据

#### CommunicationNode_APA接口方法
- `APA_StartSearchParking()` - 开始搜索车位
- `APA_StopSearchParking()` - 停止搜索车位
- `APA_SetParkInTargetParkingSpace()` - 设置泊入目标车位
- `APA_StartParkIn()` - 开始泊入
- `APA_StartParkOut()` - 开始泊出
- `APA_SuspendPark()` - 暂停泊车
- `APA_ResumePark()` - 恢复泊车
- `APA_StopPark()` - 停止泊车
- `APA_GetParkPlotMult()` - 获取多个车位信息
- `SetAPACallBack()` - 设置APA回调
- `SetVehicleControllerCallBack()` - 设置车辆控制回调

#### FusionDecision接口方法
- `IFuisonDecisionInit()` - 初始化融合决策
- `IFuisonDecisionStart()` - 启动融合决策
- `IFuisonDecisionStop()` - 停止融合决策
- `IFuisonDecisionUninit()` - 反初始化融合决策

### 9. 方法调用关系总览图

```mermaid
mindmap
  root((D-Eskimo<br/>方法调用体系))
    应用层
      ParkingFusDataDispatch
        Send_APP_SF_APA_Slot
        Send_APP_Sf_APA_ObjInfo
        Send_APP_SF_APA_Replan_Slot
        Set_SF_APA_USS_Slot_Info_CallFunc
      UIUEDataDispatch
        Send_UI_Display_Data
        Set_UI_Control_Callback
      ParkingPlanDataDispatch
        Send_Path_Plan_Request
        Set_Path_Plan_Callback
    感知融合层
      PerceptionFusion
        PerceptionFusionStart
        PerceptionFusionStop
        PerceptionSearchingSlot
        PerceptionObstcleDetect
        PerceptionParkingReplan
        PerceptionSendVeh
        PerceptionSendUslot
        PerceptionSendVpf
        PerceptionSendUSSSlot
      np_api算法
        np_init
        np_exit
        np_send_veh
        np_send_uslot
        np_send_vpf
        np_run
      VisualObject
        PerceptionPostprocess
        SelectFrameResult
        ConvertVpfData
    决策层
      FusionDecision
        IFuisonDecisionInit
        IFuisonDecisionStart
        ProcessFusionData
        MakeDecision
      ObjectFusion
        FuseObjects
        UpdateObjectList
      ParkingSpaceFusion
        FuseParkingSpaces
        UpdateParkingSpaceList
    业务逻辑层
      CBusinessLogic
        Init
        Start
        Stop
        OnEventNotifyCB
        UpdateVehicleData
        UpdateRadarData
      CommunicationNode_APA
        APA_StartSearchParking
        APA_StopSearchParking
        APA_StartParkIn
        APA_StartParkOut
        APA_SuspendPark
        APA_ResumePark
        SetAPACallBack
    通信层
      LogicProxy
        APACommunicatorStart
        comm_proxy_push_message
        comm_proxy_consume_message
        NRecvMsg_APACommunicator_OnSearchParking
      DataManager
        GetVehicleData
        UpdateVehicleData
```

## 架构说明

### 1. 应用层（VDC_APA_APP_Framework）
- **应用管理（AppM）**：管理各个应用的生命周期
- **泊车融合应用（ParkingFus）**：负责多传感器数据融合
- **UI/UE应用（UIUE）**：用户界面和用户体验
- **泊车规划应用（ParkingPlan）**：路径规划和决策
- **超声波感知应用（USSPerc）**：超声波雷达数据处理
- **传感器标定应用**：传感器标定功能

### 2. 核心层（Core）
- **业务逻辑**：核心业务处理逻辑
- **感知模块**：多传感器感知处理
- **感知融合**：多传感器数据融合
- **融合决策**：融合后的决策处理
- **定位模块**：车辆定位和融合定位
- **视觉感知**：基于视觉的感知算法
- **数据层**：各类传感器数据接口
- **服务层**：系统级服务（日志、内存、通信等）

### 3. 基础层（AppBase）
- **APA服务**：APA系统服务入口
- **心跳检测**：系统健康监控
- **主程序**：各功能模块的主程序入口

### 4. 通信协议
- **DDS**：数据分发服务，用于实时数据通信
- **SOME/IP**：面向服务的通信协议
- **IPC**：进程间通信

### 5. 外部接口
- **车辆ECU**：与车辆电子控制单元通信（EPS、ABS、IBC、DMS等）
- **传感器**：摄像头、雷达、超声波雷达等传感器接口

